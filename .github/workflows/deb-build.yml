name: Build and Publish ZFS Debs

on:
  schedule:
    - cron: '0 16 * * *'
  workflow_dispatch:
    inputs:
      ref_to_build:
        description: '要构建的 OpenZFS 分支或标签 (例如: master, zfs-2.2.0)'
        required: true
        default: 'master'
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      dist_name: ${{ steps.set_vars.outputs.dist_name }}
      should_publish: ${{ steps.set_vars.outputs.should_publish }}

    steps:
      - name: Set reusable variables
        id: set_vars
        run: |
          REF_TO_BUILD=""
          DIST_NAME=""
          SHOULD_PUBLISH="true"

          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "定时任务触发，构建 master 分支..."
            REF_TO_BUILD="master"
            DIST_NAME="nightly"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "手动触发，构建用户输入的分支/标签..."
            REF_TO_BUILD="${{ github.event.inputs.ref_to_build }}"
            if [[ "${{ github.event.inputs.ref_to_build }}" == "master" ]]; then
              DIST_NAME="nightly"
            else
              DIST_NAME="${{ github.event.inputs.ref_to_build }}"
            fi
          else
            SHOULD_PUBLISH="false"
          fi

          echo "将要构建的 Ref: $REF_TO_BUILD"
          echo "APT 发行版名称: $DIST_NAME"

          echo "ref_to_build=$REF_TO_BUILD" >> $GITHUB_OUTPUT
          echo "dist_name=$DIST_NAME" >> $GITHUB_OUTPUT
          echo "should_publish=$SHOULD_PUBLISH" >> $GITHUB_OUTPUT

      - name: Checkout OpenZFS source code
        uses: actions/checkout@v4
        with:
          repository: openzfs/zfs
          ref: ${{ steps.set_vars.outputs.ref_to_build }}
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git curl ksh bc bzip2 fio acl sysstat mdadm lsscsi parted attr dbench nfs-kernel-server samba rng-tools pax selinux-utils quota \
            alien autoconf automake build-essential debhelper-compat dh-dkms dh-python dkms fakeroot gawk libaio-dev libattr1-dev libblkid-dev \
            libcurl4-openssl-dev libelf-dev libffi-dev libpam0g-dev libssl-dev libtirpc-dev libtool libudev-dev linux-headers-generic po-debconf \
            python3 python3-all-dev python3-cffi python3-dev python3-packaging python3-setuptools python3-sphinx uuid-dev zlib1g-dev dh-autoreconf parallel
      - name: Build ZFS Debs
        run: |
          sh autogen.sh
          ./configure --enable-systemd
          make -j$(nproc) deb-utils deb-dkms
          mkdir -p out
          mv *.deb out/
          echo "编译完成的 .deb 包:"
          ls -l out/

      - name: Upload Deb Artifacts for publishing job
        uses: actions/upload-artifact@v4
        with:
          name: zfs-deb-packages
          path: out/*.deb

  publish-apt-repo:
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.outputs.should_publish == 'true'

    steps:
      - name: Install APT tools and GPG
        run: |
          sudo apt-get update
          sudo apt-get install -y apt-utils gnupg

      - name: Download deb packages
        uses: actions/download-artifact@v4
        with:
          name: zfs-deb-packages
          path: debs


      - name: Update Nightly GitHub Release
        if: needs.build.outputs.dist_name == 'nightly'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nightly
          name: Nightly Build
          body: "自动构建的最新 ZFS 开发版 .deb 包。仅供测试使用。"
          prerelease: false
          files: debs/*.deb

      - name: Create Official GitHub Release
        if: needs.build.outputs.dist_name != 'nightly'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.build.outputs.dist_name }}
          name: Release ${{ needs.build.outputs.dist_name }}
          body: "根据 OpenZFS 官方标签 `${{ needs.build.outputs.dist_name }}` 构建的 .deb 包。"
          prerelease: false
          files: debs/*.deb

      - name: Import GPG Key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Checkout gh-pages branch from your repo
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Build APT Repository
        run: |
          DIST="${{ needs.build.outputs.dist_name }}"
          echo "正在发布到 APT 发行版: $DIST"

          REPO_DIR="gh-pages/dists/$DIST/main/binary-amd64"
          mkdir -p "$REPO_DIR"

          # echo "清理旧的 .deb 包"
          # find "$REPO_DIR" -type f -name "*.deb" -delete

          echo "移动新的 .deb 包"
          find debs -type f -name "*.deb" -exec mv -f {} "$REPO_DIR/" \;

          cd gh-pages

          apt-ftparchive packages "dists/$DIST/main/binary-amd64" \
            > "dists/$DIST/main/binary-amd64/Packages"
          gzip -k -f "dists/$DIST/main/binary-amd64/Packages"

          cd "dists/$DIST"
          apt-ftparchive \
            -o APT::FTPArchive::Release::Origin="XiaoTong6666 ZFS" \
            -o APT::FTPArchive::Release::Label="XiaoTong6666 ZFS Repo" \
            -o APT::FTPArchive::Release::Suite="$DIST" \
            -o APT::FTPArchive::Release::Codename="$DIST" \
            -o APT::FTPArchive::Release::Architectures="amd64" \
            -o APT::FTPArchive::Release::Components="main" \
            release . > Release

          gpg --clearsign --yes -u "${{ steps.import_gpg.outputs.fingerprint }}" -o InRelease Release
          gpg -abs --yes -u "${{ steps.import_gpg.outputs.fingerprint }}" -o Release.gpg Release

      - name: Commit and Push to gh-pages
        run: |
          cd gh-pages
          DIST="${{ needs.build.outputs.dist_name }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .

          if ! git diff --staged --quiet; then
            git commit -m "Update APT repository for $DIST"
            git push
          else
            echo "APT 仓库没有变动 ($DIST)，无需推送。"
          fi
