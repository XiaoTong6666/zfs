name: Build ZFS Deb Packages

on:
  push:
    branches: [ "master" ] # OpenZFS 主分支通常是 master
    tags:
      - 'zfs-*'
      - 'v*'
      - '[0-9]*'
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          # 安装你列出的依赖 (移除了可能在 Ubuntu runner 上名称不一致的 linux-perf, 改用 linux-tools-generic)
          sudo apt-get install -y git curl ksh bc bzip2 fio acl sysstat mdadm linux-tools-common lsscsi parted attr dbench nfs-kernel-server samba rng-tools pax selinux-utils quota
          # 安装编译 ZFS 必须的开发包 (configure 阶段必需)
          sudo apt install alien autoconf automake build-essential debhelper-compat dh-dkms dh-python dkms fakeroot gawk libaio-dev libattr1-dev libblkid-dev libcurl4-openssl-dev libelf-dev libffi-dev libpam0g-dev libssl-dev libtirpc-dev libtool libudev-dev linux-headers-generic po-debconf python3 python3-all-dev python3-cffi python3-dev python3-packaging python3-setuptools python3-sphinx uuid-dev zlib1g-dev

      - name: Build ZFS Debs
        id: build_zfs
        run: |
          sh autogen.sh
          # 配置 Systemd
          ./configure --enable-systemd
          # 编译 deb-utils 和 deb-dkms
          make -j$(nproc) deb-utils deb-dkms

          # 创建输出目录并整理文件
          mkdir -p out
          mv *.deb out/

          # 列出文件确认
          ls -l out/

      - name: Upload Deb Artifacts (Backup)
        uses: actions/upload-artifact@v4
        with:
          name: zfs-deb-packages
          path: out/*.deb

      - name: Update Nightly Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/master'
        with:
          tag_name: nightly
          name: Nightly Build
          body: "OpenZFS Nightly Build (Auto-generated)"
          prerelease: true
          files: out/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Official Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          draft: false
          prerelease: false
          files: out/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
