name: Build ZFS Deb Packages

on:
  push:
    branches: [ "master" ] # OpenZFS 主分支通常是 master
    tags:
      - 'zfs-*'
      - 'v*'
      - '[0-9]*'
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:
    inputs:
      branch_to_build:
        description: 'The source code branch to build from'
        required: true
        default: 'master'
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.branch_to_build) || github.ref }}
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl ksh bc bzip2 fio acl sysstat mdadm linux-tools-common lsscsi parted attr dbench nfs-kernel-server samba rng-tools pax selinux-utils quota
          sudo apt install alien autoconf automake build-essential debhelper-compat dh-dkms dh-python dkms fakeroot gawk libaio-dev libattr1-dev libblkid-dev libcurl4-openssl-dev libelf-dev libffi-dev libpam0g-dev libssl-dev libtirpc-dev libtool libudev-dev linux-headers-generic po-debconf python3 python3-all-dev python3-cffi python3-dev python3-packaging python3-setuptools python3-sphinx uuid-dev zlib1g-dev

      - name: Build ZFS Debs
        id: build_zfs
        run: |
          sh autogen.sh
          ./configure --enable-systemd
          make -j$(nproc) deb-utils deb-dkms
          mkdir -p out
          mv *.deb out/
          ls -l out/

      - name: Upload Deb Artifacts (Backup)
        uses: actions/upload-artifact@v4
        with:
          name: zfs-deb-packages
          path: out/*.deb

      - name: Update Nightly Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/master'
        with:
          tag_name: nightly
          name: Nightly Build Debs
          body: "OpenZFS Nightly Build Debian Packages"
          prerelease: true
          files: out/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Official Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          draft: false
          prerelease: false
          files: out/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-apt-repo:
    needs: build
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/master') || startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y apt-utils gnupg

      - name: Download deb packages
        uses: actions/download-artifact@v4
        with:
          name: zfs-deb-packages
          path: debs

      - name: Import GPG Key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Build APT Repository
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            DIST="nightly"
          else
            DIST=$(basename "${{ github.ref }}")
          fi

          echo "Publishing to distribution: $DIST"

          REPO_DIR="gh-pages/dists/$DIST/main/binary-amd64"
          mkdir -p "$REPO_DIR"

          find debs -type f -name "*.deb" -exec mv -f {} "$REPO_DIR/" \;

          cd "gh-pages/dists/$DIST"

          apt-ftparchive packages . > Packages
          gzip -k -f Packages

          apt-ftparchive \
            -o APT::FTPArchive::Release::Origin="XiaoTong6666 ZFS" \
            -o APT::FTPArchive::Release::Label="XiaoTong6666 ZFS Repo" \
            -o APT::FTPArchive::Release::Suite="$DIST" \
            -o APT::FTPArchive::Release::Codename="$DIST" \
            -o APT::FTPArchive::Release::Architectures="amd64" \
            -o APT::FTPArchive::Release::Components="main" \
            release . > Release

          gpg --clearsign --yes -u "${{ steps.import_gpg.outputs.fingerprint }}" -o InRelease Release

          gpg -abs --yes -u "${{ steps.import_gpg.outputs.fingerprint }}" -o Release.gpg Release

      - name: Commit and Push to gh-pages
        run: |
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .

          if ! git diff --staged --quiet; then
            git commit -m "Update APT repository for ${{ github.ref_name }}"
            git push
          else
            echo "No changes to the APT repository."
          fi
